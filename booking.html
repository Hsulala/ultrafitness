<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教練預約 (偵錯模式)</title> <script src="https://cdn.tailwindcss.com"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    
    <style>
        body {
            background-color: #f0f0f0;
        }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.95); display: flex;
            justify-content: center; align-items: center; flex-direction: column;
            z-index: 9999; transition: opacity 0.5s ease;
        }
        #loading-overlay img { width: 60px; }
        #loading-overlay p { margin-top: 1rem; color: #333; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="loading-overlay">
        <img src="https://raw.githubusercontent.com/Hsulala/ultrafitness/main/loading.gif" alt="Loading...">
        <p>努力載入中...</p>
    </div>

    <div id="app" class="p-4 max-w-lg mx-auto bg-white rounded-lg shadow-md mt-5 hidden">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">教練預約 (偵錯模式)</h1>
        <div id="message" class="p-3 mb-4 text-sm rounded-lg hidden"></div>
        <div class="bg-yellow-100 text-yellow-800 p-3 rounded-lg">
            此為偵錯頁面，請打開開發人員工具(F12)並查看 Console 的輸出。
        </div>
        </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzyhXrVghRmCqHfgfvq3Mwx-RsvnD229yu57eI9xxxDYtjMTCqT8IjMHOgR90rrM_GIgQ/exec";
    const LIFF_ID = "2007905512-rO6nlL6D";
    let userId = "";

    async function main() {
        const loadingOverlay = document.getElementById('loading-overlay');
        const appDiv = document.getElementById('app');

        try {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            
            const profile = await liff.getProfile();
            userId = profile.userId;

            // =================== 偵錯實驗開始 ===================
            
            // 1. 把原本的載入功能暫時註解掉
            // await loadStudents(); 
            
            // 2. 加入我們的測試呼叫
            console.log(">>> 正在從 booking.html 測試呼叫 getRecordPageData...");
            const testResult = await callBackend({ action: 'getRecordPageData', userId: userId });
            console.log("<<< 測試呼叫的結果:", testResult);

            // =================== 偵錯實驗結束 ===================

            // 因為我們在偵錯，所以後面的畫面顯示和事件綁定可以先不做
            // 讓 loading 畫面持續顯示，我們只看 console 結果
            appDiv.classList.remove('hidden'); // 顯示偵錯提示
            setTimeout(() => { loadingOverlay.style.opacity = '0'; }, 100);
            setTimeout(() => { loadingOverlay.style.display = 'none'; }, 600);
            
            // 下面的事件綁定在偵錯時不需要執行
            // studentSelect.addEventListener('change', loadCoursesForStudent);
            // ...

        } catch (error) { 
            console.error("偵錯時發生錯誤:", error);
            loadingOverlay.innerHTML = `<p class="text-red-600 font-bold">偵錯失敗: ${error.message}</p><p>請查看 Console 以取得詳細資訊。</p>`;
        }
    }
    
    // --- 輔助函式 ---
    async function callBackend(payload) {
        // 在發送前也印出來，確保內容正確
        console.log("發送到後端的請求內容:", payload);
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'application/json' } // 確保 header 正確
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return await response.json();
    }
    
    // 為了讓主程式不報錯，保留其他函式的空殼
    function loadStudents() {}
    function loadCoursesForStudent() {}
    function updateAvailableTimes() {}
    function handleFormSubmit() {}
    function resetSelect() {}
    function showMessage() {}
    
    main();
</script>
</body>
</html>